<!DOCTYPE html>
<html>

<head>
	<title>Image Viewer</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
	<style>
		body {
			background-color: lightsteelblue;
			color: hsl(0, 0%, 10%);
		}

		@media (prefers-color-scheme: dark) {
			body {
				background-color: #0f1010;
				color: lightblue;
			}
		}

		img {
			width: 80%;
			height: auto;
		}

		input[type=range] {
 			width:50%;
		}
	</style>
</head>

<body>
	<h1>Image Viewer</h1>
	<div>
		<label for="LED_TIME">LED Time:</label>
		<input type="range" id="LED_TIME" name="LED_TIME" min="1000" max="9333" step="10" value="1000">
		<span id="LED_TIME_Value">1000</span>
	</div>

	<div>
		<label for="update_t_cur">Advance t_cur on each capture:</label>
		<input type="checkbox" id="update_t_cur" name="update_t_cur">
	</div>
	
	<div>
		<label for="LED_WIDTH">LED Width:</label>
		<input type="range" id="LED_WIDTH" name="LED_WIDTH" min="0" max="100" step="1" value="20">
		<span id="LED_WIDTH_Value">0</span>
	</div>

	<div>
		<img id="image" alt="image">
	</div>

	<script>
		var host = window.location.hostname;
		var port = window.location.port;
		var ws = new WebSocket('ws://' + host + ':' + port + '/ws');
		ws.binaryType = 'blob'; // Set the binaryType to 'blob'
		var throttle = false;
		var nextIsImage = false;

		ws.onopen = function (event) {
			$('#submit').click();
		};

		ws.onmessage = function (event) {
			if (nextIsImage && event.data instanceof Blob) {
				var imgElement = document.getElementById('image');
				if (imgElement.src !== '') {
					// console.log('Revoke blob URL:', imgElement.src); // Revoke the old object URL
					URL.revokeObjectURL(imgElement.src); // Revoke the old object URL
				}
				var url = URL.createObjectURL(event.data);
				imgElement.src = url;
				throttle = false;
				nextIsImage = false;
			} else {
				var data = JSON.parse(event.data);
				if (data.image_response && data.image_response.image === 'next') {
					nextIsImage = true;
				}
				// if ('LED_TIME' in data) {
				if (data.LED_TIME) {
					var newValue = data.LED_TIME.value;
					$('#LED_TIME').val(newValue);
					$('#LED_TIME_Value').text(newValue);
				}
			}
		};

		$('#update_t_cur').on('change', function () {
			if (ws.readyState == WebSocket.OPEN) {
				ws.send(JSON.stringify({
					'update_t_cur_enable': {
						'value': $(this).prop('checked')
					}
				}));
			}
		});

		$('input[type=range]').on('input', function () {
			var sliderId = this.id;
			var sliderValue = $(this).val();
			$('#' + sliderId + '_Value').text(sliderValue);
			if (ws.readyState == WebSocket.OPEN) {
				ws.send(JSON.stringify({
					[this.id] : {
						'value': parseInt(sliderValue)
					}
				}));
			}
		});
		
		// function handleRangeInput(sliderId) {
		// 	$('input[type=range][id=' + sliderId + ']').on('input', function () {
		// 		var sliderValue = $(this).val();
		// 		$('#' + sliderId + '_Value').text(sliderValue);
		// 		if (ws.readyState == WebSocket.OPEN) {
		// 			ws.send(JSON.stringify({
		// 				[this.id]: {
		// 					'value': parseInt(sliderValue)
		// 				}
		// 			}));
		// 		}
		// 	});
		// }

		// Call the function for each control
		// handleRangeInput('LED_TIME');
		// handleRangeInput('LED_WIDTH');
		// Add more calls as needed for other controls
	</script>
</body>

</html>